name: Build Docker Image

on:
  push:
    branches: [ main, feat/* ]
  pull_request:
    branches: [ main ]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        run: |
          docker build --platform linux/amd64 \
            -f dockerfiles/Dockerfile \
            -t memu-server .
      
      - name: Test image
        if: github.event_name == 'push'
        run: |
          docker run -d -p 8005:8000 \
            -e OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
            --name test memu-server
          sleep 5
          curl -f http://localhost:8005 || exit 1
          docker logs test
          docker stop test

  build-linux-arm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up QEMU for multi-architecture
        uses: docker/setup-qemu-action@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image for ARM64
        run: |
          docker buildx build --platform linux/arm64 \
            -f dockerfiles/Dockerfile \
            -t memu-server:arm64 \
            --load \
            .